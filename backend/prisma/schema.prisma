// ====================================
// WhatsHybrid Enterprise - Prisma Schema
// Complete schema with 30+ models
// ====================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================================
// AUTHENTICATION & USERS
// ====================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  avatar        String?
  phone         String?
  timezone      String    @default("UTC")
  language      String    @default("pt-BR")
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions          Session[]
  passwordResets    PasswordReset[]
  workspaceMembers  WorkspaceMember[]
  contacts          Contact[]
  deals             Deal[]
  tasks             Task[]
  messages          Message[]
  campaigns         Campaign[]
  activities        Activity[]
  auditLogs         AuditLog[]
  userSettings      UserSetting[]
  aiUsageLogs       AIUsageLog[]

  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String   @unique
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_resets")
}

// ====================================
// WORKSPACE MANAGEMENT
// ====================================

model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  description String?
  industry    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members          WorkspaceMember[]
  invites          WorkspaceInvite[]
  contacts         Contact[]
  labels           Label[]
  pipelines        Pipeline[]
  deals            Deal[]
  tasks            Task[]
  messages         Message[]
  campaigns        Campaign[]
  messageTemplates MessageTemplate[]
  webhooks         Webhook[]
  workspaceSettings WorkspaceSetting[]
  licenses         License[]
  subscriptions    Subscription[]
  aiCredits        AICredit[]

  @@index([slug])
  @@map("workspaces")
}

model WorkspaceMember {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  role        String   @default("member") // owner, admin, member, viewer
  permissions Json?
  joinedAt    DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

model WorkspaceInvite {
  id          String    @id @default(cuid())
  workspaceId String
  email       String
  role        String    @default("member")
  token       String    @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([token])
  @@map("workspace_invites")
}

// ====================================
// CRM - CONTACTS & LABELS
// ====================================

model Contact {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String?
  name        String
  phone       String
  email       String?
  avatar      String?
  company     String?
  position    String?
  notes       String?
  tags        String[]
  customFields Json?
  lastMessageAt DateTime?
  sentiment   String?   // positive, neutral, negative
  leadScore   Int       @default(0)
  isArchived  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Relations
  labels        ContactLabel[]
  deals         Deal[]
  messages      Message[]
  activities    Activity[]
  campaignItems CampaignItem[]

  @@unique([workspaceId, phone])
  @@index([workspaceId])
  @@index([phone])
  @@index([email])
  @@map("contacts")
}

model Label {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  color       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contacts  ContactLabel[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@map("labels")
}

model ContactLabel {
  id        String   @id @default(cuid())
  contactId String
  labelId   String
  createdAt DateTime @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  label   Label   @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([contactId, labelId])
  @@index([contactId])
  @@index([labelId])
  @@map("contact_labels")
}

// ====================================
// CRM - PIPELINE & DEALS
// ====================================

model Pipeline {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  description String?
  isDefault   Boolean  @default(false)
  position    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  stages    PipelineStage[]

  @@index([workspaceId])
  @@map("pipelines")
}

model PipelineStage {
  id         String   @id @default(cuid())
  pipelineId String
  name       String
  color      String
  position   Int
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  deals    Deal[]

  @@index([pipelineId])
  @@map("pipeline_stages")
}

model Deal {
  id          String    @id @default(cuid())
  workspaceId String
  contactId   String
  stageId     String
  userId      String?
  title       String
  value       Float     @default(0)
  currency    String    @default("BRL")
  probability Int       @default(0)
  expectedCloseDate DateTime?
  closedAt    DateTime?
  lostReason  String?
  notes       String?
  customFields Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contact   Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)
  stage     PipelineStage  @relation(fields: [stageId], references: [id])
  user      User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  activities Activity[]

  @@index([workspaceId])
  @@index([contactId])
  @@index([stageId])
  @@map("deals")
}

// ====================================
// ACTIVITIES
// ====================================

model Activity {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  userId      String   @map("user_id")
  contactId   String?  @map("contact_id")
  dealId      String?  @map("deal_id")
  type        String   // call, email, meeting, note, task_completed, etc
  title       String
  description String?
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  deal    Deal?    @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contactId])
  @@index([dealId])
  @@map("activities")
}

// ====================================
// TASKS & REMINDERS
// ====================================

model Task {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  title       String
  description String?
  priority    String    @default("medium") // low, medium, high
  status      String    @default("pending") // pending, in_progress, completed, cancelled
  dueDate     DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminders TaskReminder[]

  @@index([workspaceId])
  @@index([userId])
  @@index([status])
  @@map("tasks")
}

model TaskReminder {
  id        String   @id @default(cuid())
  taskId    String
  remindAt  DateTime
  isSent    Boolean  @default(false)
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([remindAt])
  @@map("task_reminders")
}

// ====================================
// MESSAGES
// ====================================

model Message {
  id          String   @id @default(cuid())
  workspaceId String
  contactId   String
  userId      String?
  direction   String   // inbound, outbound
  content     String
  mediaUrl    String?
  mediaType   String?
  status      String   @default("sent") // sent, delivered, read, failed
  metadata    Json?
  createdAt   DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contact   Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([contactId])
  @@index([createdAt])
  @@map("messages")
}

model MessageTemplate {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  category    String   @default("general")
  content     String
  variables   String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("message_templates")
}

// ====================================
// CAMPAIGNS
// ====================================

model Campaign {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String
  name        String
  description String?
  status      String    @default("draft") // draft, scheduled, running, paused, completed, cancelled
  messageTemplate String
  mediaUrl    String?
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CampaignItem[]

  @@index([workspaceId])
  @@index([userId])
  @@index([status])
  @@map("campaigns")
}

model CampaignItem {
  id         String    @id @default(cuid())
  campaignId String
  contactId  String
  status     String    @default("pending") // pending, sent, failed
  sentAt     DateTime?
  failReason String?
  retries    Int       @default(0)
  metadata   Json?
  createdAt  DateTime  @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@map("campaign_items")
}

// ====================================
// LICENSING & BILLING
// ====================================

model License {
  id          String    @id @default(cuid())
  workspaceId String
  licenseKey  String    @unique
  plan        String    // free, starter, professional, enterprise
  status      String    @default("active") // active, expired, suspended, cancelled
  maxUsers    Int       @default(1)
  maxContacts Int       @default(1000)
  features    Json
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([licenseKey])
  @@map("licenses")
}

model AICredit {
  id          String   @id @default(cuid())
  workspaceId String
  amount      Int      @default(0)
  used        Int      @default(0)
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("ai_credits")
}

model TopupCode {
  id        String    @id @default(cuid())
  code      String    @unique
  credits   Int
  usedBy    String?
  usedAt    DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  @@index([code])
  @@map("topup_codes")
}

model Subscription {
  id              String    @id @default(cuid())
  workspaceId     String
  stripeCustomerId String?
  stripePriceId   String?
  stripeSubscriptionId String? @unique
  plan            String
  status          String    @default("active") // active, cancelled, past_due, incomplete
  currentPeriodStart DateTime
  currentPeriodEnd DateTime
  cancelAt        DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invoices  Invoice[]

  @@index([workspaceId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model Invoice {
  id             String   @id @default(cuid())
  subscriptionId String
  stripeInvoiceId String? @unique
  amount         Float
  currency       String   @default("BRL")
  status         String   // draft, open, paid, void, uncollectible
  pdfUrl         String?
  paidAt         DateTime?
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@map("invoices")
}

// ====================================
// ANALYTICS
// ====================================

model AnalyticsDaily {
  id                String   @id @default(cuid())
  workspaceId       String
  date              DateTime @db.Date
  messagesSent      Int      @default(0)
  messagesReceived  Int      @default(0)
  newContacts       Int      @default(0)
  newDeals          Int      @default(0)
  dealsWon          Int      @default(0)
  dealsLost         Int      @default(0)
  revenue           Float    @default(0)
  aiRequestsCount   Int      @default(0)
  aiTokensUsed      Int      @default(0)
  aiCostUsd         Float    @default(0)
  createdAt         DateTime @default(now())

  @@unique([workspaceId, date])
  @@index([workspaceId])
  @@index([date])
  @@map("analytics_daily")
}

model AnalyticsHourly {
  id                String   @id @default(cuid())
  workspaceId       String
  timestamp         DateTime
  messagesSent      Int      @default(0)
  messagesReceived  Int      @default(0)
  activeUsers       Int      @default(0)
  aiRequestsCount   Int      @default(0)
  avgResponseTime   Float    @default(0)
  createdAt         DateTime @default(now())

  @@unique([workspaceId, timestamp])
  @@index([workspaceId])
  @@index([timestamp])
  @@map("analytics_hourly")
}

model AIUsageLog {
  id          String   @id @default(cuid())
  workspaceId String
  userId      String
  provider    String
  model       String
  engine      String   // copilot, smart_replies, sentiment, etc
  promptTokens Int     @default(0)
  completionTokens Int @default(0)
  totalTokens Int      @default(0)
  costUsd     Float    @default(0)
  latencyMs   Int      @default(0)
  success     Boolean  @default(true)
  errorMessage String?
  metadata    Json?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([userId])
  @@index([provider])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

// ====================================
// SETTINGS
// ====================================

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@map("settings")
}

model WorkspaceSetting {
  id          String   @id @default(cuid())
  workspaceId String
  key         String
  value       Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, key])
  @@index([workspaceId])
  @@map("workspace_settings")
}

model UserSetting {
  id        String   @id @default(cuid())
  userId    String
  key       String
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId])
  @@map("user_settings")
}

// ====================================
// WEBHOOKS
// ====================================

model Webhook {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  url         String
  events      String[]
  secret      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace  Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([workspaceId])
  @@map("webhooks")
}

model WebhookDelivery {
  id          String   @id @default(cuid())
  webhookId   String
  event       String
  payload     Json
  response    Json?
  statusCode  Int?
  success     Boolean  @default(false)
  attempt     Int      @default(1)
  nextRetryAt DateTime?
  createdAt   DateTime @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// ====================================
// AUDIT LOGS
// ====================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  workspaceId String?
  action      String
  resource    String
  resourceId  String?
  changes     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([workspaceId])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}
