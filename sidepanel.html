<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Group Extractor v6.1.0 - Side Panel</title>
    <link rel="stylesheet" href="sidepanel.css">
    <link rel="stylesheet" href="onboarding.css">
    <link rel="stylesheet" href="modules/modules.css">
</head>
<body>
    <div class="container">
        <!-- ========================================
             HEADER
        ======================================== -->
        <header class="header">
            <div class="logo">
                <img src="icons/48.png" alt="WhatsHybrid logo" class="logo-icon-img">
                <h1 id="spHeaderTitle">WhatsHybrid</h1>
            </div>
            <div class="header-actions">
                <button id="btnOpenCrmFullscreen" class="btn-icon-header" title="Abrir CRM em Nova Aba" style="font-size: 16px;">
                    ğŸ“Š
                </button>
                <button id="btnViewHistory" class="btn-icon-header" title="Ver HistÃ³rico (Ctrl+H)">
                    ğŸ“œ
                </button>
                <span class="version">v6.8.1</span>
            </div>
        </header>

        <!-- ========================================
             WHL FUSION: VIEW ROOT (dynamic content)
        ======================================== -->
        <div id="whlViewRoot" class="whl-view-root">

            <!-- ============ VIEW: PRINCIPAL ============ -->
            <section id="whlViewPrincipal" class="whl-view">
  <div class="sp-card">
    <div class="sp-title">ğŸ“¨ Disparo de mensagens â€” Envio em massa</div>
    <div class="sp-muted">Cole os nÃºmeros, escreva a mensagem, anexe uma imagem (opcional), gere a tabela e inicie a campanha.</div>

    <label class="sp-label">ğŸ“± NÃºmeros (um por linha)</label>
    <textarea id="sp_numbers" class="sp-textarea" placeholder="5511999998888&#10;5511988887777"></textarea>

    <div class="sp-row" style="margin-top:8px;align-items:center">
      <input id="sp_csv" type="file" accept=".csv,text/csv" style="display:none" />
      <button id="sp_select_csv" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“Š Importar CSV</button>
      <button id="sp_clear_csv" class="sp-btn sp-btn-danger" style="display:none">ğŸ—‘ï¸ Remover</button>
    </div>
    
    <div class="sp-row" style="margin-top:8px;align-items:center">
      <input id="sp_excel_file" type="file" accept=".xlsx,.xls" style="display:none" />
      <button id="sp_import_excel" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“Š Importar Excel</button>
    </div>
    
    <div id="sp_csv_hint" class="sp-status"></div>

    <label class="sp-label" style="margin-top:10px">ğŸ’¬ Mensagem</label>
    
    <div style="position:relative">
      <textarea id="sp_message" class="sp-textarea" style="min-height:120px;padding-right:56px" placeholder="Digite a mensagem..."></textarea>
      <button id="sp_emoji_btn" class="sp-btn sp-btn-secondary" style="position:absolute;right:8px;bottom:8px;padding:6px 10px">ğŸ˜Š</button>
      <div id="sp_emoji_picker" style="display:none;position:absolute;right:8px;bottom:50px;z-index:10;background:rgba(0,0,0,0.60);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:8px;max-width:260px"></div>
    </div>

    <div class="sp-row" style="margin-top:8px;align-items:center">
      <input id="sp_image" type="file" accept="image/*" style="display:none" />
      <button id="sp_select_image" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“ Anexar imagem</button>
      <button id="sp_clear_image" class="sp-btn sp-btn-danger" style="display:none">ğŸ—‘ï¸ Remover</button>
    </div>
    <div id="sp_image_hint" class="sp-status"></div>

    <div class="sp-row" style="margin-top:8px">
      <button id="sp_save_message" class="sp-btn sp-btn-secondary">ğŸ’¾ Salvar Mensagem</button>
    </div>

    <div class="sp-title" style="font-size:13px;margin-top:10px">ğŸ“± Preview</div>
    <div class="wa-chat">
      <div class="wa-bubble">
        <img id="sp_preview_img" src="" style="display:none;max-width:100%;border-radius:10px;margin-bottom:8px" />
        <div id="sp_preview_text" style="white-space:pre-wrap;word-break:break-word"></div>
        <div class="wa-time">
          <span id="sp_preview_meta"></span>
          <span class="wa-ticks">âœ“âœ“</span>
        </div>
      </div>
    </div>

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_build_queue" class="sp-btn sp-btn-primary" style="flex:1">ğŸ“‹ Gerar tabela</button>
      <button id="sp_clear_fields" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ§¹ Limpar</button>
    </div>

    <div id="sp_hint" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸš€ Campanha</div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
      <div style="flex:1;min-width:90px;background:rgba(0,0,0,0.10);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:8px">
        <div class="sp-muted" style="font-size:10px">âœ… Enviadas</div>
        <div id="sp_stat_sent" style="font-size:16px;font-weight:900">0</div>
      </div>
      <div style="flex:1;min-width:90px;background:rgba(0,0,0,0.10);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:8px">
        <div class="sp-muted" style="font-size:10px">âŒ Falhas</div>
        <div id="sp_stat_failed" style="font-size:16px;font-weight:900">0</div>
      </div>
      <div style="flex:1;min-width:90px;background:rgba(0,0,0,0.10);border:1px solid rgba(255,255,255,0.10);border-radius:12px;padding:8px">
        <div class="sp-muted" style="font-size:10px">â³ Pendentes</div>
        <div id="sp_stat_pending" style="font-size:16px;font-weight:900">0</div>
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="sp-muted" id="sp_progress_text">0%</div>
      <div style="height:10px;background:rgba(255,255,255,0.10);border-radius:999px;overflow:hidden">
        <div id="sp_progress_fill" style="height:100%;width:0%;background:rgba(37,211,102,0.85)"></div>
      </div>
      <div class="sp-muted" id="sp_estimated_time" style="margin-top:6px"></div>
    </div>

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_start" class="sp-btn sp-btn-primary" style="flex:1">â–¶ï¸ Iniciar</button>
      <button id="sp_pause" class="sp-btn sp-btn-secondary" style="flex:1">â¸ï¸ Pausar</button>
      <button id="sp_stop" class="sp-btn sp-btn-danger" style="flex:1">â¹ï¸ Parar</button>
    </div>

    <div id="sp_campaign_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“‹ Tabela / Fila</div>
    <div class="sp-muted" id="sp_queue_meta">0 contatos</div>

    <div class="sp-queue-container" style="margin-top:8px">
      <table>
        <thead>
          <tr>
            <th style="width:44px">#</th>
            <th>NÃºmero</th>
            <th style="width:92px">Status</th>
            <th style="width:70px">AÃ§Ã£o</th>
          </tr>
        </thead>
        <tbody id="sp_queue_table"></tbody>
      </table>
    </div>

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_skip" class="sp-btn sp-btn-secondary" style="flex:1">â­ï¸ Pular atual</button>
      <button id="sp_wipe" class="sp-btn sp-btn-danger" style="flex:1">ğŸ§¨ Zerar fila</button>
    </div>
  </div>
</section>

            <!-- ============ VIEW: EXTRATOR ============ -->
            <section id="whlViewExtrator" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ“¥ Extrator de contatos</div>
    <div class="sp-muted">Extrai contatos Normais, Arquivados e Bloqueados do WhatsApp Web.</div>

    <div class="sp-row">
      <button id="sp_extract_contacts" class="sp-btn sp-btn-primary">ğŸ“¥ Extrair</button>
      <button id="sp_refresh_extract" class="sp-btn sp-btn-secondary">ğŸ”„ Atualizar</button>
      <button id="sp_copy_extract_all" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Todos</button>
    </div>

    <div id="sp_extract_status" class="sp-status">Pronto.</div>

    <div style="margin-top:10px">
      <div class="sp-title" style="font-size:13px">âœ… Normais (<span id="sp_count_normal">0</span>)</div>
      <textarea id="sp_normal_list" class="sp-textarea"></textarea>
      <div class="sp-row" style="margin-top:6px">
        <button id="sp_copy_normal" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Normais</button>
      </div>

      <div class="sp-title" style="font-size:13px;margin-top:12px">ğŸ“ Arquivados (<span id="sp_count_archived">0</span>)</div>
      <textarea id="sp_archived_list" class="sp-textarea"></textarea>
      <div class="sp-row" style="margin-top:6px">
        <button id="sp_copy_archived" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Arquivados</button>
      </div>

      <div class="sp-title" style="font-size:13px;margin-top:12px">â›” Bloqueados (<span id="sp_count_blocked">0</span>)</div>
      <textarea id="sp_blocked_list" class="sp-textarea"></textarea>
      <div class="sp-row" style="margin-top:6px">
        <button id="sp_copy_blocked" class="sp-btn sp-btn-secondary">ğŸ“‹ Copiar Bloqueados</button>
      </div>
    </div>
  </div>
</section>

            <!-- ============ VIEW: GRUPOS (V6 - EXISTENTE) ============ -->
            <section id="whlViewGroups" class="whl-view hidden">


        <!-- ========================================
             BARRA DE STATUS
        ======================================== -->
        <div id="statusBar" class="status-bar hidden">
            <span id="statusText">Aguardando...</span>
            <div id="progressBar" class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
                <span class="progress-text" id="progressPercent">0%</span>
            </div>
            <!-- Controles de extraÃ§Ã£o -->
            <div id="extractionControls" class="extraction-controls hidden">
                <button id="btnPauseExtraction" class="btn-control btn-control-pause" title="Pausar extraÃ§Ã£o">
                    â¸ï¸ Pausar
                </button>
                <button id="btnResumeExtraction" class="btn-control btn-control-resume hidden" title="Continuar extraÃ§Ã£o">
                    â–¶ï¸ Continuar
                </button>
                <button id="btnStopExtraction" class="btn-control btn-control-stop" title="Parar extraÃ§Ã£o">
                    â¹ï¸ Parar
                </button>
            </div>
        </div>

        <!-- ========================================
             ETAPA 1: CARREGAR GRUPOS
        ======================================== -->
        <section id="step1" class="step">
            <!-- Dica de reconexÃ£o SEMPRE VISÃVEL -->
            <div class="tip-bubble tip-info" id="connectionTip">
                <div class="tip-content">
                    ğŸ’¡ Se "Carregar Grupos" nÃ£o funcionar, <strong>clique no Ã­cone da extensÃ£o</strong> (ğŸ§©) para reconectar.
                </div>
            </div>

            <!-- NOVO: Dica de reconexÃ£o (oculta por padrÃ£o) -->
            <div class="tip-bubble tip-warning" id="reconnectTip" style="display: none;">
                <div class="tip-content">
                    âš ï¸ ConexÃ£o perdida. <strong>Clique no Ã­cone da extensÃ£o</strong> (ğŸ§©) para reconectar.
                </div>
            </div>

            <button id="btnLoadGroups" class="btn btn-primary btn-large">
                <span class="btn-icon">ğŸ“‚</span>
                Carregar Grupos
            </button>
            
            <button id="btnForceRefresh" class="btn btn-secondary" style="margin-top:8px;display:none">
                <span class="btn-icon">ğŸ”„</span>
                ForÃ§ar AtualizaÃ§Ã£o
            </button>

            <!-- Atalhos -->
            <div class="shortcuts-box">
                <p class="shortcuts-title">âŒ¨ï¸ Atalhos:</p>
                <ul class="shortcuts-list">
                    <li><kbd>Ctrl+L</kbd> Carregar grupos</li>
                    <li><kbd>Ctrl+H</kbd> Ver histÃ³rico</li>
                    <li><kbd>Ctrl+F</kbd> Buscar grupo</li>
                </ul>
            </div>
        </section>

        <!-- ========================================
             ETAPA 2: SELECIONAR GRUPO
        ======================================== -->
        <section id="step2" class="step hidden">
            <div class="groups-header">
                <h2>Selecione um Grupo</h2>
                <span id="groupCount" class="badge">0 grupos</span>
            </div>

            <!-- EstatÃ­sticas -->
            <div id="groupStats" class="group-stats">
                <div class="stat-item" id="statTotal">
                    <span class="stat-icon">ğŸ“Š</span>
                    <div class="stat-info">
                        <span class="stat-label">Total:</span>
                        <span class="stat-value">0</span>
                        <span class="stat-unit">grupos</span>
                    </div>
                </div>
                
                <!-- SEPARADOR 1 - Entre Total e Ativos -->
                <div class="stats-separator"></div>
                
                <div class="stat-item" id="statActive">
                    <span class="stat-icon">âœ…</span>
                    <div class="stat-info">
                        <span class="stat-label">Ativos:</span>
                        <span class="stat-value">0</span>
                    </div>
                </div>
                
                <!-- SEPARADOR 2 - Entre Ativos e Arquivados -->
                <div class="stats-separator"></div>
                
                <div class="stat-item" id="statArchived">
                    <span class="stat-icon">ğŸ“¦</span>
                    <div class="stat-info">
                        <span class="stat-label">Arquivados:</span>
                        <span class="stat-value">0</span>
                    </div>
                </div>
            </div>

            <!-- Filtros por abas -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">
                    <span class="tab-icon">ğŸ“‹</span> Todos
                </button>
                <button class="filter-tab" data-filter="active">
                    <span class="tab-icon">ğŸ’¬</span> Ativos
                </button>
                <button class="filter-tab" data-filter="archived">
                    <span class="tab-icon">ğŸ“¦</span> Arquivados
                </button>
            </div>

            <!-- Campo de busca -->
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input 
                    type="text" 
                    id="searchGroups" 
                    placeholder="Filtrar grupos..." 
                    autocomplete="off" 
                />
            </div>

            <!-- Lista de grupos (Virtual Scroll) -->
            <div id="groupsList" class="groups-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Carregando grupos...</p>
                </div>
            </div>

            <!-- AÃ§Ãµes -->
            <div class="actions">
                <button id="btnBack" class="btn btn-secondary">
                    â† Voltar
                </button>
                <button id="btnExtract" class="btn btn-primary" disabled>
                    <span class="btn-icon">ğŸ“¥</span>
                    Extrair Membros
                </button>
            </div>
        </section>

        <!-- ========================================
             ETAPA 3: RESULTADO
        ======================================== -->
        <section id="step3" class="step hidden">
            <div class="result-header">
                <span class="result-icon">âœ…</span>
                <h2>ExtraÃ§Ã£o ConcluÃ­da!</h2>
            </div>

            <!-- InformaÃ§Ãµes do resultado -->
            <div class="result-info">
                <div class="result-item">
                    <span class="label">Grupo:</span>
                    <span id="resultGroupName" class="value">-</span>
                </div>
                <div class="result-item">
                    <span class="label">Status:</span>
                    <span id="resultGroupStatus" class="value">-</span>
                </div>
                <div class="result-item">
                    <span class="label">Membros:</span>
                    <span id="resultMemberCount" class="value">-</span>
                </div>
            </div>

            <!-- Lista de membros extraÃ­dos (Virtual Scroll) -->
            <div class="members-container">
                <h3 class="members-title">
                    <span class="members-icon">ğŸ‘¥</span>
                    Membros ExtraÃ­dos
                </h3>
                <div id="membersList" class="members-list">
                    <!-- Membros serÃ£o inseridos aqui via Virtual Scroll -->
                </div>
            </div>

            <!-- BotÃµes de exportaÃ§Ã£o -->
            <div class="export-buttons">
                <button id="btnExportCSV" class="btn btn-export" title="Exportar como CSV (Ctrl+S)">
                    ğŸ“„ CSV
                </button>
                <button id="btnCopyList" class="btn btn-export" title="Copiar lista">
                    ğŸ“‹ Copiar
                </button>
            </div>

            <!-- BotÃµes Google Sheets -->
            <div class="sheets-buttons">
                <button id="btnCopySheets" class="btn btn-sheets" title="Copiar para Google Sheets (Ctrl+G)">
                    <span class="btn-icon">ğŸ“Š</span> Copiar para Sheets
                </button>
                <button id="btnOpenSheets" class="btn btn-sheets-outline" title="Abrir no Google Sheets">
                    <span class="btn-icon">ğŸ”—</span> Abrir no Sheets
                </button>
            </div>

            <!-- BotÃ£o nova extraÃ§Ã£o -->
            <button id="btnNewExtraction" class="btn btn-secondary btn-large">
                ğŸ”„ Nova ExtraÃ§Ã£o
            </button>
        </section>

        <!-- ========================================
             ETAPA 4: HISTÃ“RICO
        ======================================== -->
        <section id="step4" class="step hidden">
            <div class="history-header">
                <h2>ğŸ“œ HistÃ³rico de ExtraÃ§Ãµes</h2>
            </div>

            <!-- EstatÃ­sticas do histÃ³rico -->
            <div id="historyStats" class="history-stats">
                <!-- Stats serÃ£o inseridas dinamicamente -->
            </div>

            <!-- Lista do histÃ³rico -->
            <div id="historyList" class="history-list">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Carregando histÃ³rico...</p>
                </div>
            </div>

            <!-- AÃ§Ãµes do histÃ³rico -->
            <div class="actions">
                <button id="btnBackFromHistory" class="btn btn-secondary">
                    â† Voltar
                </button>
                <button id="btnClearHistory" class="btn btn-danger">
                    ğŸ—‘ï¸ Limpar Tudo
                </button>
            </div>
        </section>

        <!-- ========================================
             MENSAGEM DE ERRO
        ======================================== -->
        <div id="errorBox" class="error-box hidden">
            <span class="error-icon">âš ï¸</span>
            <span id="errorText" class="error-text">Erro desconhecido</span>
            <button id="btnDismissError" class="btn-dismiss" title="Fechar">
                âœ•
            </button>
        </div>

            </section>

            <!-- ============ VIEW: RECOVER ============ -->
            <section id="whlViewRecover" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ”„ Recover</div>
    <div class="sp-muted">Mostra mensagens apagadas/editadas capturadas em tempo real (salvas no histÃ³rico local do WhatsApp Web).</div>

    <div class="sp-row">
      <button id="sp_refresh_recover" class="sp-btn sp-btn-secondary">ğŸ”„ Atualizar</button>
      <button id="sp_download_all_recover" class="sp-btn sp-btn-primary">â¬‡ï¸ Baixar Todos</button>
      <button id="sp_clear_recover" class="sp-btn sp-btn-danger">ğŸ—‘ï¸ Limpar</button>
    </div>

    <div class="sp-row" style="margin-top:8px;align-items:center;justify-content:space-between">
      <div class="sp-muted">Total: <b id="sp_recover_total">0</b></div>
      <div class="sp-muted">Mostrando atÃ© 200</div>
    </div>

    <div id="sp_recover_status" class="sp-status">Pronto.</div>

    <div id="sp_recover_timeline" class="timeline-container"></div>
  </div>
</section>

            <!-- ============ VIEW: CONFIG ============ -->
            <section id="whlViewConfig" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">âš™ï¸ ConfiguraÃ§Ãµes</div>
    <div class="sp-muted">Ajuste delays, agendamento, templates e relatÃ³rio (igual ao mÃ³dulo original).</div>

    <label class="sp-label">â±ï¸ Delay mÃ­nimo (segundos)</label>
    <input id="sp_delay_min" type="number" class="sp-input" min="0" step="0.5" placeholder="Ex: 2" />

    <label class="sp-label" style="margin-top:10px">â±ï¸ Delay mÃ¡ximo (segundos)</label>
    <input id="sp_delay_max" type="number" class="sp-input" min="0" step="0.5" placeholder="Ex: 6" />

    <div class="sp-row" style="margin-top:10px">
      <button id="sp_save_settings" class="sp-btn sp-btn-primary" style="flex:1">ğŸ’¾ Salvar</button>
      <button id="sp_reload_settings" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ”„ Recarregar</button>
    </div>

    <div id="sp_config_status" class="sp-status">Pronto.</div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“… Agendamentos</div>
    <div class="sp-muted">Agende mÃºltiplas campanhas para horÃ¡rios diferentes.</div>
    
    <div class="sp-row" style="margin-top:10px">
      <input id="sp_schedule_name" class="sp-input" placeholder="Nome da campanha" style="flex:2">
      <input id="sp_schedule_time" type="datetime-local" class="sp-input" style="flex:2">
      <button id="sp_add_schedule" class="sp-btn sp-btn-primary" style="white-space:nowrap">â• Agendar</button>
    </div>
    
    <div id="sp_schedules_list" class="sp-queue-container" style="margin-top:8px;max-height:250px"></div>
    <div id="sp_schedule_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ›¡ï¸ Anti-Ban Inteligente</div>
    <div class="sp-muted">ProteÃ§Ã£o contra bloqueios com delays inteligentes e limite diÃ¡rio.</div>
    
    <label class="sp-label">Limite diÃ¡rio de mensagens</label>
    <input id="sp_daily_limit" type="number" class="sp-input" value="200" min="1" max="1000">
    
    <div class="sp-row" style="margin-top:8px">
      <span class="sp-muted">Enviadas hoje: <b id="sp_sent_today">0</b> / <b id="sp_daily_limit_display">200</b></span>
    </div>
    
    <div id="sp_daily_progress" style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin-top:8px">
      <div id="sp_daily_progress_fill" style="height:100%;width:0%;background:#25D366;border-radius:4px;transition:width 0.3s"></div>
    </div>
    
    <label class="sp-checkbox" style="margin-top:10px">
      <input type="checkbox" id="sp_business_hours_only">
      <span>Enviar apenas em horÃ¡rio comercial (8h-20h)</span>
    </label>
    
    <div class="sp-row" style="margin-top:10px">
      <button id="sp_save_antiban" class="sp-btn sp-btn-primary">ğŸ’¾ Salvar</button>
      <button id="sp_reset_daily_count" class="sp-btn sp-btn-secondary">ğŸ”„ Resetar contador</button>
    </div>
    
    <div id="sp_antiban_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ”” NotificaÃ§Ãµes</div>
    <div class="sp-muted">Alertas desktop para eventos importantes.</div>
    
    <label class="sp-checkbox">
      <input type="checkbox" id="sp_enable_notifications" checked>
      <span>Ativar notificaÃ§Ãµes desktop</span>
    </label>
    
    <label class="sp-checkbox">
      <input type="checkbox" id="sp_enable_sounds" checked>
      <span>Ativar sons</span>
    </label>
    
    <button id="sp_test_notification" class="sp-btn sp-btn-secondary" style="margin-top:8px">ğŸ”” Testar NotificaÃ§Ã£o</button>
    <div id="sp_notification_status" class="sp-status"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“ Templates</div>
    <div class="sp-muted">Salva e restaura fila, mensagem, imagem e contatos extraÃ­dos. Suporte a variÃ¡veis dinÃ¢micas.</div>

    <div class="sp-row" style="align-items:center">
      <input id="sp_draft_name" type="text" class="sp-input" placeholder="Nome do template" />
      <button id="sp_save_draft" class="sp-btn sp-btn-primary" style="white-space:nowrap">Salvar</button>
    </div>
    
    <div class="sp-muted" style="margin-top:8px;font-size:11px">
      ğŸ“Œ VariÃ¡veis disponÃ­veis: {nome}, {empresa}, {data}, {hora}, {numero}, {saudacao}
    </div>

    <div class="sp-queue-container" style="margin-top:8px;max-height:36vh">
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th style="width:92px">Data</th>
            <th style="width:52px">#</th>
            <th style="width:92px">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="sp_drafts_body"></tbody>
      </table>
    </div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“„ RelatÃ³rio</div>
    <div class="sp-muted">Exportar CSV da fila e copiar falhas.</div>

    <div class="sp-row">
      <button id="sp_export_report" class="sp-btn sp-btn-secondary" style="flex:1">â¬‡ï¸ Exportar CSV</button>
      <button id="sp_copy_failed" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ“‹ Copiar falhas</button>
    </div>

    <div id="sp_report_hint" class="sp-status"></div>
  </div>
</section>

            <!-- ============ VIEW: BACKUP ============ -->
            <section id="whlViewBackup" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ’¾ Backup</div>
    <div class="sp-muted">Exporte conversas do WhatsApp Web (HTML/JSON/CSV/TXT) e baixe mÃ­dias em ZIP (opcional).</div>

    <div class="sp-row" style="align-items:center; gap:10px">
      <span id="bk_status_pill" class="sp-pill pending">Verificandoâ€¦</span>
      <span id="bk_status_text" class="sp-muted" style="margin:0">â€”</span>
      <button id="bk_refresh" class="sp-btn sp-btn-secondary" style="margin-left:auto">ğŸ”„ Atualizar</button>
    </div>

    <div id="bk_wrong_page" class="sp-status" style="margin-top:10px; display:none">Abra o WhatsApp Web (web.whatsapp.com) e faÃ§a login.</div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“‡ Selecionar conversa</div>
    <div class="sp-muted">Por padrÃ£o, exporta a conversa aberta no WhatsApp. Se preferir, selecione uma conversa abaixo.</div>

    <div class="sp-row">
      <button id="bk_export_current" class="sp-btn sp-btn-primary" style="flex:1">ğŸ“¤ Exportar conversa atual</button>
    </div>

    <div class="sp-row" style="margin-top:8px">
      <button id="bk_load_contacts" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ”„ Carregar contatos</button>
      <button id="bk_clear_selection" class="sp-btn sp-btn-secondary" style="flex:1">ğŸ§¹ Limpar seleÃ§Ã£o</button>
    </div>

    <label class="sp-label">ğŸ” Buscar</label>
    <input id="bk_search_contacts" class="sp-input" placeholder="Digite para filtrar..." />

    <!-- Ãrea de contato selecionado para backup -->
    <div id="bk_selected_contact_display" class="sp-card" style="margin-top:10px; display:none; background: rgba(37,211,102,0.15); border: 1px solid rgba(37,211,102,0.3);">
      <div style="display:flex; align-items:center; gap:12px;">
        <img id="bk_selected_avatar" src="" alt="Avatar" style="width:48px; height:48px; border-radius:50%; object-fit:cover; display:none;" />
        <div id="bk_selected_avatar_placeholder" style="width:48px; height:48px; border-radius:50%; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; font-size:20px;">ğŸ‘¤</div>
        <div style="flex:1;">
          <div id="bk_selected_name" style="font-weight:700; font-size:14px; color:#fff;">Nenhum contato selecionado</div>
          <div id="bk_selected_info" class="sp-muted" style="font-size:12px;">Selecione um contato ou exporte a conversa atual</div>
        </div>
      </div>
    </div>

    <div id="bk_selected_box" class="sp-status" style="margin-top:10px; display:none"></div>

    <div id="bk_contacts_list" class="groups-list" style="margin-top:10px; max-height:320px"></div>
  </div>

  <div class="sp-card">
    <div class="sp-title">âš™ï¸ OpÃ§Ãµes de exportaÃ§Ã£o</div>
    <div class="sp-muted">O download inicia automaticamente. Se selecionar mÃ­dias, serÃ¡ gerado um ZIP por tipo.</div>

    <label class="sp-label">Formato</label>
    <select id="bk_format" class="sp-input">
      <option value="html">HTML (recomendado)</option>
      <option value="json">JSON</option>
      <option value="csv">CSV</option>
      <option value="txt">TXT</option>
    </select>

    <label class="sp-label">Limite de mensagens</label>
    <select id="bk_limit" class="sp-input">
      <option value="100">100</option>
      <option value="500">500</option>
      <option value="1000">1000</option>
      <option value="5000">5000</option>
      <option value="-1">Todas (pode demorar)</option>
    </select>

    <div class="sp-row" style="margin-top:10px">
      <div style="flex:1">
        <label class="sp-label">De (data)</label>
        <input id="bk_date_from" type="date" class="sp-input" />
      </div>
      <div style="flex:1">
        <label class="sp-label">AtÃ© (data)</label>
        <input id="bk_date_to" type="date" class="sp-input" />
      </div>
    </div>

    <label class="sp-checkbox" style="margin-top:10px">
      <input type="checkbox" id="bk_inc_ts" />
      <span>Incluir timestamps</span>
    </label>

    <label class="sp-checkbox">
      <input type="checkbox" id="bk_inc_sender" checked />
      <span>Incluir remetente</span>
    </label>

    <div style="margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.10)">
      <div class="sp-title">ğŸ–¼ï¸ MÃ­dias (opcional)</div>
      <div class="sp-muted">Baixa mÃ­dias da conversa em ZIP. Dependendo do volume, pode demorar.</div>

      <label class="sp-checkbox">
        <input type="checkbox" id="bk_export_images" checked />
        <span>Imagens</span>
      </label>
      <label class="sp-checkbox">
        <input type="checkbox" id="bk_export_videos" />
        <span>VÃ­deos</span>
      </label>
      <label class="sp-checkbox">
        <input type="checkbox" id="bk_export_audios" />
        <span>Ãudios</span>
      </label>
      <label class="sp-checkbox">
        <input type="checkbox" id="bk_export_docs" />
        <span>Documentos</span>
      </label>
    </div>

    <div class="sp-row" style="margin-top:12px">
      <button id="bk_export" class="sp-btn sp-btn-primary" style="flex:1">â¬‡ï¸ Exportar</button>
      <button id="bk_cancel" class="sp-btn sp-btn-secondary" style="flex:1; display:none">â›” Cancelar</button>
    </div>

    <div id="bk_progress_box" style="margin-top:12px; display:none">
      <div class="progress-bar">
        <div id="bk_bar_fill" class="progress-fill" style="width:0%"></div>
        <div id="bk_prog_pct" class="progress-text">0%</div>
      </div>
      <div class="sp-row" style="margin-top:8px; justify-content:space-between; align-items:center">
        <span id="bk_prog_status" class="sp-muted" style="margin:0">â€”</span>
        <span id="bk_prog_detail" class="sp-muted" style="margin:0">0 / 0</span>
      </div>
      <div id="bk_media_progress" class="sp-muted" style="margin-top:8px; font-size:11px; display:none"></div>
    </div>

    <div id="bk_feedback" class="sp-status" style="margin-top:10px">Pronto.</div>
  </div>
</section>

            <!-- ============ VIEW: CRM ============ -->
            <section id="whlViewCrm" class="whl-view hidden">
  <div class="sp-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); border: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div class="sp-title" style="color: white;">ğŸ’¼ CRM Kanban</div>
        <div class="sp-muted" style="color: rgba(255,255,255,0.8);">ExperiÃªncia completa em tela cheia</div>
      </div>
      <button id="crm_open_fullscreen" class="sp-btn" style="background: white; color: #8b5cf6; font-weight: 600; padding: 10px 20px;">
        ğŸš€ Abrir em Nova Aba
      </button>
    </div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ’¼ CRM - Pipeline de Vendas</div>
    <div class="sp-muted">Gerencie seus contatos e negÃ³cios em um Kanban visual.</div>

    <div class="sp-row" style="margin-top:12px">
      <button id="crm_new_deal" class="sp-btn sp-btn-primary">â• Novo NegÃ³cio</button>
      <button id="crm_new_contact" class="sp-btn sp-btn-secondary">ğŸ‘¤ Novo Contato</button>
      <button id="crm_refresh" class="sp-btn sp-btn-secondary">ğŸ”„</button>
    </div>
  </div>

  <div class="sp-card" id="crm_kanban_container">
    <!-- Kanban serÃ¡ renderizado aqui pelo mÃ³dulo -->
    <div class="whl-empty">Carregando CRM...</div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ·ï¸ Etiquetas / Labels</div>
    <div class="sp-muted">Organize seus contatos com etiquetas personalizadas.</div>
    <div id="labels_manager_container" style="margin-top:12px">
      <!-- Labels serÃ£o renderizadas aqui -->
    </div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ“œ Atividades Recentes</div>
    <div id="crm_activities_container">
      <!-- Timeline serÃ¡ renderizada aqui -->
    </div>
  </div>
</section>

            <!-- ============ VIEW: ANALYTICS ============ -->
            <section id="whlViewAnalytics" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ“Š Analytics & MÃ©tricas</div>
    <div class="sp-muted">Acompanhe o desempenho das suas campanhas e mensagens.</div>

    <div class="sp-row" style="margin-top:12px">
      <button id="analytics_refresh" class="sp-btn sp-btn-secondary">ğŸ”„ Atualizar</button>
      <button id="analytics_export" class="sp-btn sp-btn-secondary">ğŸ“¤ Exportar</button>
      <button id="analytics_reset" class="sp-btn sp-btn-danger">ğŸ—‘ï¸ Resetar</button>
    </div>
  </div>

  <div id="analytics_dashboard_container">
    <!-- Dashboard serÃ¡ renderizado aqui pelo mÃ³dulo -->
    <div class="whl-empty">Carregando mÃ©tricas...</div>
  </div>
</section>

            <!-- ============ VIEW: TASKS ============ -->
            <section id="whlViewTasks" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ“‹ Sistema de Tarefas</div>
    <div class="sp-muted">Gerencie seus lembretes e follow-ups com contatos.</div>
  </div>

  <!-- Stats de Tasks -->
  <div class="sp-card" id="tasks_stats_container" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
    <div style="text-align:center;padding:8px;background:rgba(139,92,246,0.1);border-radius:8px">
      <div style="font-size:20px;font-weight:700" id="stat_total">0</div>
      <div style="font-size:10px;color:var(--sp-muted)">Total</div>
    </div>
    <div style="text-align:center;padding:8px;background:rgba(245,158,11,0.1);border-radius:8px">
      <div style="font-size:20px;font-weight:700;color:#F59E0B" id="stat_pending">0</div>
      <div style="font-size:10px;color:var(--sp-muted)">Pendentes</div>
    </div>
    <div style="text-align:center;padding:8px;background:rgba(239,68,68,0.1);border-radius:8px">
      <div style="font-size:20px;font-weight:700;color:#EF4444" id="stat_overdue">0</div>
      <div style="font-size:10px;color:var(--sp-muted)">Atrasadas</div>
    </div>
    <div style="text-align:center;padding:8px;background:rgba(16,185,129,0.1);border-radius:8px">
      <div style="font-size:20px;font-weight:700;color:#10B981" id="stat_completed">0</div>
      <div style="font-size:10px;color:var(--sp-muted)">ConcluÃ­das</div>
    </div>
  </div>

  <div class="sp-card" id="tasks_container">
    <!-- Lista de tarefas serÃ¡ renderizada aqui pelo mÃ³dulo (inclui filtros e botÃ£o nova tarefa) -->
    <div class="whl-empty">Carregando tarefas...</div>
  </div>
</section>

            <!-- ============ VIEW: SMART REPLIES (IA) ============ -->
            <section id="whlViewAi" class="whl-view hidden">
  <div class="sp-card">
    <div class="sp-title">ğŸ¤– Smart Replies com IA</div>
    <div class="sp-muted">Configure respostas inteligentes e automÃ¡ticas usando IA.</div>
  </div>

  <div class="sp-card" id="smart_replies_settings_container">
    <!-- ConfiguraÃ§Ãµes serÃ£o renderizadas aqui -->
    <div class="whl-empty">Carregando configuraÃ§Ãµes...</div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ§ª Testar IA</div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <textarea id="ai_test_input" class="sp-input" rows="3" placeholder="Digite uma mensagem para testar a IA..."></textarea>
      <div class="sp-row">
        <button id="ai_test_btn" class="sp-btn sp-btn-primary" style="flex:1">ğŸš€ Gerar Resposta</button>
        <button id="ai_correct_btn" class="sp-btn sp-btn-secondary">âœï¸ Corrigir Texto</button>
      </div>
      <div id="ai_test_output" class="sp-card" style="background:rgba(139,92,246,0.1);display:none">
        <div class="sp-muted" style="font-size:11px;margin-bottom:4px">Resposta da IA:</div>
        <div id="ai_test_result"></div>
      </div>
    </div>
  </div>

  <div class="sp-card">
    <div class="sp-title">âš¡ Respostas RÃ¡pidas</div>
    <div id="quick_replies_container">
      <!-- Quick replies serÃ£o renderizadas aqui -->
    </div>
  </div>

  <div class="sp-card">
    <div class="sp-title">ğŸ’¡ SugestÃµes de Respostas</div>
    <div class="sp-muted">As sugestÃµes aparecerÃ£o aqui quando vocÃª receber mensagens.</div>
    <div id="ai_suggestions_container" style="margin-top:8px">
      <!-- SugestÃµes serÃ£o renderizadas aqui -->
    </div>
  </div>

  <div class="sp-card" id="subscription_widget_container">
    <div class="sp-title">ğŸ’³ Sua Assinatura</div>
    <!-- Widget de assinatura serÃ¡ renderizado aqui -->
  </div>
</section>

        </div>



        <!-- ========================================
             FOOTER
        ======================================== -->
        <footer class="footer">
            <span class="footer-text">
                WhatsApp Group Member Extractor
            </span>
        </footer>
    </div>

    <!-- ========================================
         SCRIPTS - SEM type="module"
    ======================================== -->
    <!-- SheetJS: Removido por CSP. Excel import usa alternativa local se disponÃ­vel -->
    
    <!-- Utilities -->
    <script src="utils/utils-optimized.js"></script>
    <script src="utils/storage.js"></script>
    <script src="utils/google-sheets-export.js"></script>
    <script src="utils/templates.js"></script>
    
    <!-- New advanced utilities -->
    <script src="utils/scheduler.js"></script>
    <script src="utils/anti-ban.js"></script>
    <script src="utils/contact-importer.js"></script>
    <script src="utils/group-cache.js"></script>
    <script src="utils/notifications.js"></script>
    
    <!-- Modules - Sistema completo baseado no Quantum CRM -->
    <script src="modules/event-bus.js"></script>
    <script src="modules/chart-engine.js"></script>
    <script src="modules/notifications.js"></script>
    <script src="modules/analytics.js"></script>
    <script src="modules/crm.js"></script>
    <script src="modules/tasks.js"></script>
    <script src="modules/smart-replies.js"></script>
    <script src="modules/subscription.js"></script>
    <script src="modules/labels.js"></script>
    <!-- Injetores sÃ£o carregados no content script, nÃ£o no sidepanel -->
    <script src="modules/init.js"></script>
    
    <!-- Core scripts -->
    <script src="onboarding.js"></script>
    <script src="sidepanel.js"></script>
    <script src="sidepanel-router.js"></script>
    <script src="sidepanel-fixes.js"></script>
    
    <!-- Fix: Garantir texto branco em TODAS as Ã¡reas com fundo colorido -->
    <style>
        /* ===== REGRA GLOBAL: Todo texto deve ser branco ===== */
        
        /* Ãrea de teste da IA */
        #ai_test_output,
        #ai_test_output *,
        #ai_test_result,
        #ai_test_result * {
            color: white !important;
        }
        #ai_test_output {
            background: rgba(139, 92, 246, 0.1) !important;
        }
        
        /* Todos os inputs, textareas e selects */
        input, textarea, select,
        .sp-input, .sp-textarea, .sp-select,
        .mod-input, .mod-textarea, .mod-select {
            color: white !important;
        }
        
        /* Todos os containers de cards e resultados */
        .sp-card, .mod-card,
        .sp-card *, .mod-card * {
            color: white;
        }
        
        /* Areas de resultado/output especÃ­ficas */
        [id*="result"], [id*="output"], [id*="preview"],
        [class*="result"], [class*="output"], [class*="preview"] {
            color: white !important;
        }
        
        /* Modais */
        .mod-modal, .mod-modal *,
        [class*="modal"], [class*="modal"] * {
            color: white;
        }
        
        /* Corrigir qualquer texto que herda preto */
        .whl-view, .whl-view *,
        .sp-section, .sp-section *,
        .section-content, .section-content * {
            color: inherit;
        }
        
        /* Placeholders mais visÃ­veis */
        ::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        
        /* Labels e textos auxiliares */
        label, .sp-label, .mod-label {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        
        /* BotÃµes com fundo amarelo/claro - usar texto escuro */
        .btn-control-pause,
        [style*="background: yellow"],
        [style*="background:#ff"],
        [style*="background: #ff"] {
            color: #1a1a2e !important;
            text-shadow: none !important;
        }
        
        /* Smart Replies floating panel */
        .sr-floating-panel, .sr-floating-panel *,
        .sr-suggestion-text, .sr-correction-input {
            color: white !important;
        }
        
        /* Garantir contraste em badges */
        .mod-badge, .whl-label-badge {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
    </style>
    
    <!-- Initialize Modules - v49 com mÃ³dulos funcionais -->
    <script src="sidepanel-handlers.js"></script>
</body>
</html>
